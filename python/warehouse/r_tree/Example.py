# -*- coding: utf-8 -*-
"""
Created on 2021/5/31 10:51

@author: sun shaowen
"""
import pyproj
from rtree import index
from shapely import ops
from shapely import wkt
from shapely.geometry import Point, Polygon
from functools import partial


def circle2points(lon: float, lat: float, m: float) -> list:
    """
    将圆近似成多个点(多边形)
    """
    proj_wgs84 = pyproj.Proj(proj='longlat', datum='WGS84', ellps='WGS84', towgs84=(0, 0, 0))
    # Azimuthal equidistant projection
    aeqd_proj = '+proj=aeqd +lat_0={lat} +lon_0={lon} +x_0=0 +y_0=0'
    project = partial(
        pyproj.transform,
        pyproj.Proj(aeqd_proj.format(lat=lat, lon=lon)),
        proj_wgs84)
    buf = Point(0, 0).buffer(m)  # distance in metres
    return ops.transform(project, buf).exterior.coords[:]


idx = index.Index()

aoi = "POLYGON((116.402209 39.951492,116.402204 39.951503,116.402201 39.951688,116.402204 39.952021,116.40223 39.95206,116.402252 39.952078,116.402379 39.952116,116.403256 39.952204,116.404481 39.95231,116.404579 39.952286,116.404681 39.952233,116.404865 39.952203,116.405123 39.952217,116.405779 39.952245,116.406293 39.952265,116.405997 39.954096,116.406663 39.954144,116.406668 39.954293,116.407898 39.954452,116.407738 39.955107,116.407729 39.955459,116.407746 39.955526,116.407816 39.955541,116.409272 39.955626,116.409867 39.955666,116.409952 39.955622,116.410047 39.955511,116.410082 39.955166,116.410138 39.954624,116.410168 39.954572,116.410249 39.954533,116.410317 39.954509,116.410395 39.954483,116.410552 39.954452,116.41084 39.954422,116.411091 39.954427,116.411343 39.954455,116.411557 39.954498,116.411733 39.954564,116.411817 39.954608,116.41193 39.954679,116.411921 39.954816,116.411916 39.955728,116.411919 39.955755,116.41195 39.955766,116.41199 39.955774,116.412162 39.955785,116.412219 39.955788,116.412247 39.95577,116.412259 39.955729,116.412524 39.950904,116.412496 39.950666,116.412448 39.950464,116.41228 39.950277,116.412194 39.950194,116.412037 39.950102,116.411837 39.950042,116.411665 39.950008,116.41144 39.949986,116.411288 39.949968,116.410755 39.949929,116.410428 39.949874,116.410231 39.949815,116.410031 39.949751,116.409826 39.949765,116.409498 39.949834,116.409384 39.949834,116.408482 39.949767,116.40773 39.949706,116.407025 39.949655,116.406942 39.949661,116.406865 39.949654,116.406646 39.949637,116.406626 39.949641,116.406612 39.949654,116.406577 39.949965,116.406386 39.951624,116.406372 39.951647,116.406341 39.951656,116.404892 39.951526,116.404858 39.951531,116.404846 39.951547,116.40481 39.951666,116.40474 39.951734,116.404081 39.951681,116.403109 39.951617,116.402975 39.951557,116.40223 39.951491,116.402209 39.951492))"
aoi_ = "POLYGON((98.329513 39.870716,98.332437 39.8712,98.334925 39.8696,98.335927 39.870335,98.335975 39.870376,98.336226 39.870391,98.340453 39.87067,98.342265 39.870788,98.341524 39.871461,98.341902 39.871617,98.342507 39.871121,98.343 39.870628,98.344264 39.869599,98.351152 39.863914,98.3516 39.863578,98.35207 39.862296,98.352299 39.861533,98.355408 39.861852,98.355644 39.860571,98.354397 39.860413,98.352408 39.859929,98.350785 39.859542,98.34882 39.858995,98.348449 39.858865,98.348106 39.8586,98.347644 39.858135,98.354841 39.852169,98.356206 39.85076,98.356433 39.849698,98.355645 39.848348,98.352421 39.84594,98.349745 39.845897,98.348824 39.845767,98.347624 39.846307,98.324716 39.865198,98.326514 39.866998,98.321242 39.871211,98.325297 39.874182,98.329513 39.870716))"
poly = wkt.loads(aoi)
poly_ = wkt.loads(aoi_)

left, bottom, right, top = poly.bounds
idx.insert(0, (left, bottom, right, top))

left, bottom, right, top = poly_.bounds
idx.insert(1, (left, bottom, right, top))

circle = Polygon(circle2points(116.409888, 39.951662, 10)).bounds
res = idx.intersection((116.40977097803078, 39.95157193725566, 116.41000502196921, 39.95175206274294))
print(list(res))
